#!/bin/bash

mkdir -p /usr/local/var/log
exec &>/usr/local/var/log/locationchanger.log

sleep 2

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

OS_VERSION=$(sw_vers -productVersion | cut -d. -f1)

get_ssid_comprehensive() {
    local os_version=$(sw_vers -productVersion | cut -d. -f1)
    local ssid=""
    
    # For macOS 26.0+, try multiple methods due to privacy restrictions
    if [ "$os_version" -ge "26" ]; then
        echo "$(date) macOS $os_version detected, using comprehensive SSID detection"
        
        # Method 1: Try shortcuts if available
        if command -v shortcuts >/dev/null 2>&1; then
            echo "$(date) Trying Shortcuts method..."
            ssid=$(shortcuts run "Current Wi-Fi" 2>/dev/null | tr -d '\r' | sed 's/^\s*//;s/\s*$//')
            if [ -n "$ssid" ] && [ "$ssid" != "null" ] && [ "$ssid" != "<redacted>" ]; then
                echo "$(date) SSID found via Shortcuts: $ssid"
                echo "$ssid"
                return 0
            fi
            echo "$(date) Shortcuts method failed or returned redacted/null"
        fi
        
        # Method 2: Try networksetup
        echo "$(date) Trying networksetup method..."
        ssid=$(networksetup -getairportnetwork en0 2>/dev/null | sed 's/Current Wi-Fi Network: //' | grep -v "You are not associated")
        if [ -n "$ssid" ] && [ "$ssid" != "You are not associated with an AirPort network." ]; then
            echo "$(date) SSID found via networksetup: $ssid"
            echo "$ssid"
            return 0
        fi
        echo "$(date) networksetup method failed"
        
        # Method 3: Try system preferences (may require admin)
        echo "$(date) Trying system preferences method..."
        ssid=$(defaults read /Library/Preferences/SystemConfiguration/com.apple.airport.preferences 2>/dev/null | grep -A 1 "SSID_STR" | tail -1 | sed 's/.*= "\(.*\)";/\1/' 2>/dev/null)
        if [ -n "$ssid" ] && [ "$ssid" != "<redacted>" ]; then
            echo "$(date) SSID found via system preferences: $ssid"
            echo "$ssid"
            return 0
        fi
        echo "$(date) System preferences method failed"
        
        # Method 4: Try system_profiler (likely to be redacted but worth trying)
        echo "$(date) Trying system_profiler method..."
        ssid=$(system_profiler SPAirPortDataType 2>/dev/null | awk '/Current Network/ {getline; gsub(":", ""); gsub(/^[[:space:]]*/, ""); gsub(/[[:space:]]*$/, ""); print; exit}')
        if [ -n "$ssid" ] && [ "$ssid" != "<redacted>" ]; then
            echo "$(date) SSID found via system_profiler: $ssid"
            echo "$ssid"
            return 0
        fi
        echo "$(date) system_profiler method failed or returned redacted"
        
        echo "$(date) All SSID detection methods failed on macOS 26.0+ - privacy restrictions may be blocking access"
        return 1
    else
        # Legacy method for older macOS versions
        echo "$(date) Using legacy SSID detection for macOS $os_version"
        ssid=$(system_profiler SPAirPortDataType 2>/dev/null | awk '/Current Network/ {getline; gsub(":", ""); print; exit}' | xargs)
        if [ -n "$ssid" ]; then
            echo "$(date) SSID found via legacy method: $ssid"
            echo "$ssid"
            return 0
        fi
        echo "$(date) Legacy SSID detection failed"
        return 1
    fi
}

SSID=$(get_ssid_comprehensive)
echo `date` "New SSID found: $SSID"

LOCATION=

Location_Automatic="Automatic"
Location_Home="Home"
Location_Work="Company Intranet"

SSID_TelekomPublic=Telekom
SSID_Home=HomeSSID
SSID_Work=WorkSSID

case $SSID in
	$SSID_TelekomPublic ) LOCATION="$Location_Automatic";;
	$SSID_Home          ) LOCATION="$Location_Home";;
	$SSID_Work  ) LOCATION="$Location_Work";;
esac
REASON="SSID changed to $SSID"

MAP_FILE=$SCRIPT_DIR/locationchanger.conf
if [ -f "$MAP_FILE" ]; then
  while IFS=' ' read -r loc wifi
  do
		if [[ "${loc}" == "#"*   ]]; then
			true
		elif [ -z "${loc}" ]; then
      true
		else
			wifi=$(echo $wifi | tr -d '"' )
			if [[ "$wifi" == "$SSID" ]]; then
					LOCATION="$loc"
					REASON="SSID changed to $SSID using mapping file"
					break
			fi
		fi
  done < "$MAP_FILE"
fi

if [ -z "$LOCATION" ]; then
	LOCATION="$Location_Automatic"
	REASON="Automatic Fallback"
fi

current_location=$(networksetup -getcurrentlocation)
if [ "$current_location" = "$LOCATION" ]; then
    exit
fi

if ! sudo /usr/local/bin/locationchanger-helper "$LOCATION"; then
		osascript -e "display notification \"Failed to Change Network Location to: $LOCATION\" with title \"Network Update Failure\""
    exit 1
fi
echo ""

EXTERNAL_CALLOUT="$SCRIPT_DIR/locationchanger.callout.sh"
if [[ -x "$EXTERNAL_CALLOUT" ]]; then
		echo "Calling external executable \"$EXTERNAL_CALLOUT\""
		output=$($EXTERNAL_CALLOUT "$LOCATION")
		exit_code=$?
		echo "exit code: $exit_code and output: $output"
fi

osascript -e "display notification \"Network Location Changed to $LOCATION\" with title \"Network Update\""

echo "--> Location Changer: $LOCATION - $REASON"

exit 0
